#! /usr/bin/env bash
# Loop over a list of backups in riffdata
#   - restore the backup
#   - create a meeting w/ room use count report
#   - craete a yaml meeting report

MONGO_ARCHIVES=(
                mongodb_riff-test.RR.asb-my.backup-20201123100752.gz
                mongodb_riff-test.RR.boldly-app.backup-20201123100813.gz
                mongodb_riff-test.RR.callcoach.backup-20201123100833.gz
                mongodb_riff-test.RR.clarovc.backup-20201123100923.gz
                mongodb_riff-test.RR.digital-leaders.backup-20201123100948.gz
                mongodb_riff-test.RR.esme.backup-20201123101013.gz
                mongodb_riff-test.RR.hackforthepeople.backup-20201123101051.gz
                mongodb_riff-test.RR.knowfully.backup-20201123101117.gz
                mongodb_riff-test.RR.learningseeds.backup-20201123101143.gz
                mongodb_riff-test.RR.learnlaunch.backup-20201123101208.gz
                mongodb_riff-test.RR.manpower.backup-20201123101237.gz
                mongodb_riff-test.RR.mfs.backup-20201123101303.gz
                mongodb_riff-test.RR.mikecardus.backup-20201123101322.gz
                mongodb_riff-test.RR.my.backup-20201123100731.gz
                mongodb_riff-test.RR.nleadership.backup-20201123101357.gz
                mongodb_riff-test.RR.riffai.backup-20201123100700.gz
                mongodb_riff-test.RR.roiinstitute.backup-20201123101434.gz
                mongodb_riff-test.RR.surfx.backup-20201123101455.gz
                mongodb_riff-test.RR.swedishdoulas.backup-20201123101525.gz
                mongodb_riff-test.RR.teamwpoff.backup-20201123101553.gz
                mongodb_riff-test.RR.ude-vet.backup-20201123101621.gz
                mongodb_riff-test.RR.ventureuniversity.backup-20201123101642.gz
                mongodb_riff-test.RR.webhose.backup-20201123101710.gz
                mongodb_riff-test.RR.wiwin-homeschooling.backup-20201123101736.gz
               )

DATE_SUFFIX='2020-11-23'

for archive in ${MONGO_ARCHIVES[@]}
do
    echo "Analyzing meetings in riffdata archive '$archive'..."

    SITE_NAME=${archive#mongodb_riff-test.RR.}
    SITE_NAME=${SITE_NAME%%.backup-*}

    echo "Site: ${SITE_NAME}"
    echo

    ./analyze-data drop-riffdata-db
    bin/mongo-restore.sh $archive
    # example report file name: reports/meetings-RR-riffai_2020-11-23.rpt
    ./analyze-data meetings -R count > reports/meetings-RR-${SITE_NAME}_${DATE_SUFFIX}.rpt
    ./analyze-data meetings --format yaml > reports/meetings-RR-${SITE_NAME}_${DATE_SUFFIX}.yml

    echo "...Finished Analyzing meetings in riffdata archive '$archive'"
    echo
done

